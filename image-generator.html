<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Character Image Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: none;
        }
        #result.show {
            display: block;
        }
        .loading {
            text-align: center;
            font-style: italic;
        }
        .prompt-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            line-height: 1.6;
        }
        .warning {
            background: rgba(255, 152, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }
        .copy-btn {
            margin-top: 10px;
            padding: 10px;
            background: #2196F3;
            width: auto;
            display: inline-block;
        }
        .copy-btn:hover {
            background: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Medication Character Generator</h1>
        
        <div class="warning">
            <strong>‚úÖ API Key Configured!</strong> 
            Ready to generate images with Gemini's Imagen 3 technology.
        </div>

        <div class="input-group">
            <label for="medName">Medication Name:</label>
            <input type="text" id="medName" placeholder="e.g., Robitussin, Mucinex, etc." />
        </div>

        <div class="input-group">
            <label for="medType">Medication Type:</label>
            <select id="medType">
                <option value="cough syrup">Cough Syrup</option>
                <option value="pill">Pill</option>
                <option value="inhaler">Inhaler</option>
                <option value="nasal spray">Nasal Spray</option>
                <option value="tablet">Tablet</option>
                <option value="capsule">Capsule</option>
                <option value="drops">Drops</option>
            </select>
        </div>

        <div class="input-group">
            <label for="artStyle">Art Style:</label>
            <select id="artStyle">
                <option value="pixel art">Pixel Art (8-bit/16-bit)</option>
                <option value="cartoon">Cartoon Style</option>
                <option value="chibi">Chibi/Cute Style</option>
                <option value="flat design">Flat Design</option>
            </select>
        </div>

        <button id="generateBtn" onclick="generateImage()">üé® Generate Character Image</button>

        <div id="result">
            <h2>Generated Character:</h2>
            <div id="imageContainer" style="text-align: center; margin: 20px 0;">
                <img id="generatedImage" style="max-width: 100%; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);" />
            </div>
            <button class="copy-btn" onclick="downloadImage()">ÔøΩ Download Image</button>
            <p style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                üí° <strong>Next Steps:</strong> 
                <br>‚Ä¢ Use this image in your game sprites
                <br>‚Ä¢ Edit in image software if needed
                <br>‚Ä¢ Generate variations with different styles
            </p>
        </div>
    </div>

    <script src="gemini-config.js"></script>
    <script>
        let currentImageData = null;
        let retryTimeout = null;

        async function generateImage() {
            const medName = document.getElementById('medName').value;
            const medType = document.getElementById('medType').value;
            const artStyle = document.getElementById('artStyle').value;
            const resultDiv = document.getElementById('result');
            const imageElement = document.getElementById('generatedImage');
            const btn = document.getElementById('generateBtn');

            if (!medName) {
                alert('Please enter a medication name!');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'üé® Generating image... (this may take 10-30 seconds)';
            resultDiv.classList.remove('show');

            try {
                // Try to generate actual image first
                console.log('Attempting to generate image with Gemini...');
                const result = await generateMedicationImage(medName, medType, artStyle);
                
                // Convert base64 to displayable image
                currentImageData = result.imageData;
                const mimeType = result.mimeType || 'image/png';
                imageElement.src = `data:${mimeType};base64,${result.imageData}`;
                
                resultDiv.classList.add('show');
                
                console.log('‚úÖ Image generated successfully!');
                
            } catch (error) {
                console.error('Image generation error:', error);
                
                // Check if it's a rate limit error
                if (error.message.includes('Rate limit') || error.message.includes('429')) {
                    const waitTime = 60;
                    alert(`‚è±Ô∏è Rate Limit Exceeded!\n\nYou've hit the API rate limit.\n\nPlease wait ${waitTime} seconds and try again.\n\nFree tier limits:\n‚Ä¢ 60 requests per minute\n‚Ä¢ 1,500 requests per day`);
                    
                    // Auto-enable button after wait time
                    let countdown = waitTime;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        btn.textContent = `‚è±Ô∏è Wait ${countdown}s before retrying...`;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            btn.disabled = false;
                            btn.textContent = 'üé® Generate Character Image';
                        }
                    }, 1000);
                    
                } else if (error.message.includes('not support image generation') || error.message.includes('text description')) {
                    // Fallback to description generation
                    alert('‚ö†Ô∏è Image generation not available yet.\n\nGenerating a detailed description instead that you can use with DALL-E, Midjourney, or Stable Diffusion.');
                    
                    try {
                        btn.textContent = 'üìù Generating description...';
                        const description = await generateImageDescription(medName, medType, artStyle);
                        
                        // Show description in a text area instead
                        const container = document.getElementById('imageContainer');
                        container.innerHTML = `
                            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; text-align: left;">
                                <h3>Generated Description (use with DALL-E or Midjourney):</h3>
                                <p style="line-height: 1.6; margin: 15px 0;">${description}</p>
                                <button onclick="copyDescription()" class="copy-btn" style="width: 100%;">üìã Copy Description</button>
                                <p style="margin-top: 15px; font-size: 14px; opacity: 0.8;">
                                    Use this description with:<br>
                                    ‚Ä¢ <a href="https://chat.openai.com" target="_blank" style="color: #fff;">ChatGPT (DALL-E)</a><br>
                                    ‚Ä¢ <a href="https://www.midjourney.com" target="_blank" style="color: #fff;">Midjourney</a><br>
                                    ‚Ä¢ <a href="https://beta.dreamstudio.ai" target="_blank" style="color: #fff;">Stable Diffusion</a>
                                </p>
                            </div>
                        `;
                        resultDiv.classList.add('show');
                        
                        // Store description for copying
                        window.currentDescription = description;
                        
                    } catch (descError) {
                        alert('‚ùå Error generating description: ' + descError.message);
                    }
                    
                } else {
                    alert('‚ùå Error generating image: ' + error.message + '\n\nCheck browser console (F12) for details.\n\nTry:\n1. Wait a minute and retry\n2. Use the Node.js method instead\n3. Check API key and internet connection');
                }
            } finally {
                if (btn.textContent.includes('Generating')) {
                    btn.disabled = false;
                    btn.textContent = 'üé® Generate Character Image';
                }
            }
        }

        function downloadImage() {
            if (!currentImageData) {
                alert('No image to download!');
                return;
            }

            const medName = document.getElementById('medName').value;
            const fileName = `${medName.toLowerCase().replace(/\s+/g, '-')}-character.png`;
            
            // Create download link
            const link = document.createElement('a');
            link.href = `data:image/png;base64,${currentImageData}`;
            link.download = fileName;
            link.click();
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Downloaded!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }
        
        function copyDescription() {
            if (window.currentDescription) {
                navigator.clipboard.writeText(window.currentDescription).then(() => {
                    alert('‚úÖ Description copied to clipboard!\n\nNow paste it into DALL-E, Midjourney, or Stable Diffusion.');
                });
            }
        }

        // Allow Enter key to trigger generation
        document.getElementById('medName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') generateImage();
        });
    </script>
</body>
</html>
