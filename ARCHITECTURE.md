# ğŸ® System Architecture Diagram

## Character Generation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     npm run load-character                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  load-character.js: Entry Point                                  â”‚
â”‚  â””â”€> Calls initializeCharacter()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  character-generator.js: getRandomEntry()                        â”‚
â”‚  â””â”€> Reads entries.json                                         â”‚
â”‚  â””â”€> Randomly selects one medication entry                      â”‚
â”‚                                                                  â”‚
â”‚  OUTPUT: { account_id, med_id, med_name, med_desc, streak }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  firebase-utils.js: getCharacter(account_id, med_id)            â”‚
â”‚  â””â”€> Queries Firestore: characters/{account_id}_{med_id}       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                               â”‚
            â–¼ EXISTS                        â–¼ NOT FOUND
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load existing char    â”‚      â”‚ CREATE NEW CHARACTER          â”‚
â”‚                       â”‚      â”‚                               â”‚
â”‚ Check if streak       â”‚      â”‚ 1. sprite-generator.js        â”‚
â”‚ crossed threshold     â”‚      â”‚    generateFeatures()         â”‚
â”‚                       â”‚      â”‚    â””â”€> Gemini AI analyzes     â”‚
â”‚ If YES:               â”‚      â”‚        med_desc              â”‚
â”‚   Calculate new stats â”‚      â”‚    â””â”€> Selects 3 features    â”‚
â”‚   updateCharacterStatsâ”‚      â”‚    â””â”€> Generates reasons     â”‚
â”‚                       â”‚      â”‚                               â”‚
â”‚ If NO:                â”‚      â”‚ 2. sprite-generator.js        â”‚
â”‚   Return existing     â”‚      â”‚    generateCharacterSprite()  â”‚
â”‚                       â”‚      â”‚    â””â”€> Gemini creates image   â”‚
â”‚                       â”‚      â”‚    â””â”€> Pixelate (8x8 grid)    â”‚
â”‚                       â”‚      â”‚    â””â”€> Remove white bg        â”‚
â”‚                       â”‚      â”‚    â””â”€> Upload to Firebase     â”‚
â”‚                       â”‚      â”‚                               â”‚
â”‚                       â”‚      â”‚ 3. stat-calculator.js         â”‚
â”‚                       â”‚      â”‚    â””â”€> calculateHP(streak)    â”‚
â”‚                       â”‚      â”‚    â””â”€> calculateAttack(streak)â”‚
â”‚                       â”‚      â”‚    â””â”€> calculateScale(streak) â”‚
â”‚                       â”‚      â”‚                               â”‚
â”‚                       â”‚      â”‚ 4. firebase-utils.js          â”‚
â”‚                       â”‚      â”‚    saveCharacter()            â”‚
â”‚                       â”‚      â”‚    â””â”€> Store in Firestore     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RETURN COMPLETE CHARACTER OBJECT                                â”‚
â”‚                                                                  â”‚
â”‚  {                                                               â”‚
â”‚    account_id: "user_alpha73",                                  â”‚
â”‚    med_id: "MED_101A",                                          â”‚
â”‚    med_name: "Claritinex Forte",                                â”‚
â”‚    med_desc: "...",                                             â”‚
â”‚    streak: 55,                                                  â”‚
â”‚    hp: 137,                                                     â”‚
â”‚    attack: 10,                                                  â”‚
â”‚    scale: 1,                                                    â”‚
â”‚    sprite_url: "https://firebasestorage...",                   â”‚
â”‚    feature_1: "fireball",                                       â”‚
â”‚    feature_2: "shield",                                         â”‚
â”‚    feature_3: "none",                                           â”‚
â”‚    feature_1_reason: "High damage from crystalline laser",      â”‚
â”‚    feature_2_reason: "Clarity effect provides protection",      â”‚
â”‚    feature_3_reason: "Two features sufficient"                  â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Stat Calculation Logic

```
Input: streak (days)
    â”‚
    â”œâ”€> Convert to months: streakMonths = streak / 30
    â”‚
    â”œâ”€> Calculate HP:
    â”‚   â”œâ”€ < 3mo:  random(50, 200)
    â”‚   â”œâ”€ 3-6mo:  random(200, 500)
    â”‚   â””â”€ 6+mo:   random(500, 1000)
    â”‚
    â”œâ”€> Calculate Attack:
    â”‚   â”œâ”€ < 2mo:    10
    â”‚   â”œâ”€ 2-4mo:    random(30, 70)
    â”‚   â”œâ”€ 4-8mo:    random(70, 100)
    â”‚   â”œâ”€ 8-12mo:   random(100, 150)
    â”‚   â””â”€ 12+mo:    175
    â”‚
    â””â”€> Calculate Scale:
        â”œâ”€ < 3mo:    1
        â”œâ”€ 3-7mo:    1.5
        â”œâ”€ 7-12mo:   2
        â””â”€ 12+mo:    3
```

---

## Sprite Generation Pipeline

```
medication data
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gemini AI Prompt        â”‚
â”‚ "Create pixel art char" â”‚
â”‚ "White background"      â”‚
â”‚ "8-bit style"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gemini 2.5-flash-image  â”‚
â”‚ Returns base64 PNG      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save raw image          â”‚
â”‚ {id}-raw.png            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sharp: Resize to 1/8    â”‚
â”‚ (1024x1024 â†’ 128x128)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sharp: Resize to 8x     â”‚
â”‚ (128x128 â†’ 1024x1024)   â”‚
â”‚ Kernel: nearest         â”‚
â”‚ Result: Pixelated!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Remove white pixels     â”‚
â”‚ Threshold: RGB > 240    â”‚
â”‚ Set alpha = 0           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save final sprite       â”‚
â”‚ {id}-sprite.png         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Convert to base64       â”‚
â”‚ Upload to Firebase      â”‚
â”‚ Storage                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
       Firebase URL
```

---

## Feature Selection AI Flow

```
med_desc
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gemini AI Prompt                     â”‚
â”‚ "Based on this medication desc..."   â”‚
â”‚ "Select 3 features from list..."     â”‚
â”‚ "Explain reasoning for each..."      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gemini 2.0-flash-exp                 â”‚
â”‚ Returns JSON:                        â”‚
â”‚ {                                    â”‚
â”‚   feature_1: "fireball",             â”‚
â”‚   feature_1_reason: "...",           â”‚
â”‚   feature_2: "shield",               â”‚
â”‚   feature_2_reason: "...",           â”‚
â”‚   feature_3: "none",                 â”‚
â”‚   feature_3_reason: "..."            â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     Store in character object
```

---

## Firebase Data Model

```
Firestore: /characters
    â”‚
    â”œâ”€ user_alpha73_MED_101A/
    â”‚   â”œâ”€ account_id: "user_alpha73"
    â”‚   â”œâ”€ med_id: "MED_101A"
    â”‚   â”œâ”€ med_name: "Claritinex Forte"
    â”‚   â”œâ”€ med_desc: "..."
    â”‚   â”œâ”€ streak: 55
    â”‚   â”œâ”€ hp: 137
    â”‚   â”œâ”€ attack: 10
    â”‚   â”œâ”€ scale: 1
    â”‚   â”œâ”€ sprite_url: "https://..."
    â”‚   â”œâ”€ feature_1: "fireball"
    â”‚   â”œâ”€ feature_1_reason: "..."
    â”‚   â”œâ”€ feature_2: "shield"
    â”‚   â”œâ”€ feature_2_reason: "..."
    â”‚   â”œâ”€ feature_3: "none"
    â”‚   â”œâ”€ feature_3_reason: "..."
    â”‚   â”œâ”€ created_at: "2025-10-04..."
    â”‚   â””â”€ updated_at: "2025-10-04..."
    â”‚
    â””â”€ user_beta48_MED_202B/
        â””â”€ ...

Storage: /sprites
    â”‚
    â”œâ”€ user_alpha73_MED_101A.png
    â”œâ”€ user_beta48_MED_202B.png
    â””â”€ ...
```

---

## Module Dependencies

```
load-character.js
    â””â”€> character-generator.js
            â”œâ”€> firebase-utils.js
            â”‚       â””â”€> firebase-config.js
            â”œâ”€> stat-calculator.js
            â””â”€> sprite-generator.js
                    â”œâ”€> @google/genai
                    â”œâ”€> sharp
                    â””â”€> firebase-utils.js
```

---

## Threshold Detection Example

```
User streak changes: 89 days â†’ 91 days

Step 1: Convert to months
    89 / 30 = 2.97 months
    91 / 30 = 3.03 months

Step 2: Check thresholds
    HP threshold at 3 months: CROSSED! âœ…
    Scale threshold at 3 months: CROSSED! âœ…

Step 3: Recalculate stats
    Old HP: 150 (range 50-200)
    New HP: 350 (range 200-500) â¬†ï¸
    
    Old Scale: 1x
    New Scale: 1.5x â¬†ï¸
    
    Old Attack: 10 (unchanged, threshold at 2 months)
    New Attack: 10

Step 4: Update Firebase
    updateCharacterStats(account_id, med_id, 91, 350, 10, 1.5)
```
